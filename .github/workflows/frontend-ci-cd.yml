name: Deploy

on:
  push:
    branches:
      - dev
      - test
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - Development
          - Test
          - Production

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Build (test)
        run: npm run build
        env:
          VITE_API_BASE_URL: "http://localhost:5000"

  set-matrix:
    needs: build-and-test
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_deploy: ${{ steps.set-matrix.outputs.should_deploy }}
    steps:
      - name: Determine deployment matrix
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            case "${{ github.ref_name }}" in
              dev)
                echo 'matrix={"include":[{"env":"dev","branch":"dev"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                ;;
              test)
                echo 'matrix={"include":[{"env":"test","branch":"test"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                ;;
              main)
                echo 'matrix={"include":[{"env":"prod","branch":"main"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                ;;
              *)
                echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=false' >> $GITHUB_OUTPUT
                ;;
            esac
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "${{ inputs.environment }}" in
              Development)
                echo 'matrix={"include":[{"env":"dev","branch":"dev"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                ;;
              Test)
                echo 'matrix={"include":[{"env":"test","branch":"test"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                ;;
              Production)
                echo 'matrix={"include":[{"env":"prod","branch":"main"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                ;;
              *)
                echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=false' >> $GITHUB_OUTPUT
                ;;
            esac
          else
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
            echo 'should_deploy=false' >> $GITHUB_OUTPUT
          fi

  # Build static files
  build:
    needs: set-matrix
    if: needs.set-matrix.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    environment: ${{ matrix.env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build with environment API URL
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.env }}
          path: dist/
          retention-days: 1

  # Deploy via FTP
  deploy:
    needs: [set-matrix, build]
    if: needs.set-matrix.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    environment: ${{ matrix.env }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ matrix.env }}
          path: dist/

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via FTP
        run: |
          lftp -c "
            set ftp:ssl-allow no;
            set ssl:verify-certificate no;
            open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
            mirror -R --delete --verbose dist/ ${{ secrets.FTP_SERVER_DIR }};
            quit
          "

      - name: Cleanup artifact
        run: rm -rf dist/
