name: Deploy

on:
  push:
    branches:
      - dev
      - test
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - Development
          - Test
          - Production

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Build (test)
        run: npm run build
        env:
          VITE_API_BASE_URL: "http://localhost:5000"

  set-matrix:
    needs: build-and-test
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_deploy: ${{ steps.set-matrix.outputs.should_deploy }}
      deploy_type: ${{ steps.set-matrix.outputs.deploy_type }}
    steps:
      - name: Determine deployment matrix
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            case "${{ github.ref_name }}" in
              dev)
                echo 'matrix={"include":[{"env":"dev","branch":"dev","image_tag":"dev-latest","compose":"docker-compose.dev.yml"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                echo 'deploy_type=docker' >> $GITHUB_OUTPUT
                ;;
              test)
                echo 'matrix={"include":[{"env":"test","branch":"test","image_tag":"test-latest","compose":"docker-compose.test.yml"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                echo 'deploy_type=docker' >> $GITHUB_OUTPUT
                ;;
              main)
                echo 'matrix={"include":[{"env":"prod","branch":"main"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                echo 'deploy_type=ftp' >> $GITHUB_OUTPUT
                ;;
              *)
                echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=false' >> $GITHUB_OUTPUT
                echo 'deploy_type=none' >> $GITHUB_OUTPUT
                ;;
            esac
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "${{ inputs.environment }}" in
              Development)
                echo 'matrix={"include":[{"env":"dev","branch":"dev","image_tag":"dev-latest","compose":"docker-compose.dev.yml"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                echo 'deploy_type=docker' >> $GITHUB_OUTPUT
                ;;
              Test)
                echo 'matrix={"include":[{"env":"test","branch":"test","image_tag":"test-latest","compose":"docker-compose.test.yml"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                echo 'deploy_type=docker' >> $GITHUB_OUTPUT
                ;;
              Production)
                echo 'matrix={"include":[{"env":"prod","branch":"main"}]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=true' >> $GITHUB_OUTPUT
                echo 'deploy_type=ftp' >> $GITHUB_OUTPUT
                ;;
              *)
                echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
                echo 'should_deploy=false' >> $GITHUB_OUTPUT
                echo 'deploy_type=none' >> $GITHUB_OUTPUT
                ;;
            esac
          else
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
            echo 'should_deploy=false' >> $GITHUB_OUTPUT
            echo 'deploy_type=none' >> $GITHUB_OUTPUT
          fi

  # ============================================
  # DOCKER BUILD & DEPLOY (dev, test)
  # ============================================
  build-docker:
    needs: set-matrix
    if: needs.set-matrix.outputs.should_deploy == 'true' && needs.set-matrix.outputs.deploy_type == 'docker'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    environment: ${{ matrix.env }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image repo
        run: echo "IMAGE_REPO=${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          tags: |
            ghcr.io/${{ env.IMAGE_REPO }}:${{ matrix.image_tag }}
            ghcr.io/${{ env.IMAGE_REPO }}:${{ github.sha }}

  deploy-docker:
    needs: [set-matrix, build-docker]
    if: needs.set-matrix.outputs.should_deploy == 'true' && needs.set-matrix.outputs.deploy_type == 'docker'
    runs-on: self-hosted
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    environment: ${{ matrix.env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "IMAGE_REPO=${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Login to GHCR
        run: echo '${{ secrets.GHCR_PAT }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin

      - name: Pull and deploy
        run: |
          export IMAGE_REPO="${IMAGE_REPO}"
          export IMAGE_TAG="${{ matrix.image_tag }}"
          export COMPOSE_PROJECT_NAME="frontend-${{ matrix.env }}"
          
          docker compose -f ${{ matrix.compose }} pull
          docker compose -f ${{ matrix.compose }} up -d

      - name: Cleanup old Docker images
        run: docker image prune -af --filter 'until=168h' || true

  # ============================================
  # FTP BUILD & DEPLOY (prod/main only)
  # ============================================
  build-ftp:
    needs: set-matrix
    if: needs.set-matrix.outputs.should_deploy == 'true' && needs.set-matrix.outputs.deploy_type == 'ftp'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    environment: ${{ matrix.env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build with production API URL
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.env }}
          path: dist/
          retention-days: 1

  deploy-ftp:
    needs: [set-matrix, build-ftp]
    if: needs.set-matrix.outputs.should_deploy == 'true' && needs.set-matrix.outputs.deploy_type == 'ftp'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    environment: ${{ matrix.env }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ matrix.env }}
          path: dist/

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via FTP
        run: |
          lftp -c "
            set ftp:ssl-allow no;
            set ssl:verify-certificate no;
            open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
            mirror -R --delete --verbose dist/ ${{ secrets.FTP_SERVER_DIR }};
            quit
          "

      - name: Cleanup artifact
        run: rm -rf dist/
